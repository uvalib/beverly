<?xml version="1.0" encoding="UTF-8"?>

<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
  xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
  http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd
  http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0 http://svn.apache.org/repos/asf/aries/tags/blueprint-0.3.1/blueprint-cm/src/main/resources/org/apache/aries/blueprint/compendium/cm/blueprint-cm-1.1.0.xsd">
  
  <description> Router for indexing workflows. Depends on repository connectivity and Solr connectivity.</description>

  <!-- OSGI blueprint property placeholder -->
  <cm:property-placeholder id="indexer.placeholder" persistent-id="indexer.properties">
    <cm:default-properties>
      <cm:property name="indexable-cm" value="info:fedora/indexable:cm"/>
    </cm:default-properties>
  </cm:property-placeholder>

  <camelContext id="indexer" xmlns="http://camel.apache.org/schema/blueprint" streamCache="true">   

    <propertyPlaceholder id="properties" location="blueprint:indexer.placeholder"/>

    <route>
      <description>Entry point for all indexing workflows</description>
      <from uri="nmr:service:indexing:index"/>
      <choice>
        <when>
          <description>Is this a purgeObject operation?</description>
          <simple>${header.methodName} == 'purgeObject'</simple>
          <!-- fire a Solr delete operation at the index, in case it was an indexable object -->
          <to uri="velocity:velocity/solr/delete.vm"/>
          <to uri="nmr:endpoint:indexing:solr:update"/>
          <!-- but also assume that it might have been an indexer object -->
          <!-- first gather the affected objects -->
          <to uri="velocity:velocity/sparql/getindexedobjects.vm"/>
          <to uri="nmr:service:repositories:resource-index"/>
          <!-- remove the appropriate no-longer-relevant RELS-INT triples -->
          <split parallelProcessing="true">
            <xpath>/rdf:RDF/rdf:Description</xpath>
            <removeHeader headerName="methodName"/>
            <!-- remove the appropriate no-longer-relevant RELS-INT triple -->
            <setHeader headerName="subject">
              <!-- peel out the indexable subject -->
              <xpath resultType="java.lang.String">/rdf:Description/@rdf:about</xpath>
            </setHeader>
            <to uri="velocity:velocity/atom/removetriples.vm"/>
            <removeHeader headerName="subject"/>
            <to uri="nmr:service:repositories:api-m"/>
            <!-- don't need to explicitly reindex the object because we just
              called purgeRelationship on it, which will trigger reindexing-->
          </split>
        </when>
        <otherwise>
          <description>This object was not purged, so we can retrieve info about it from its
            repo</description>
          <!-- is this a content object or an indexer object? -->
          <to uri="velocity:velocity/sparql/getcontentmodels.vm"/>
          <to uri="nmr:service:repositories:resource-index"/>
          <choice>
            <when>
              <description>Does this object have the indexable CM?</description>
              <xpath>/rdf:RDF/rdf:Description/fedora-model:hasModel/@rdf:resource = '{{indexable-cm}}'</xpath>
              <choice>
                <when>
                  <description>Is this a purgeDatastream operation?</description>
                  <simple>${header.methodName} == 'purgeDatastream'</simple>
                  <!-- first remove any dependent RELS-INT triples -->
                  <to uri="velocity:velocity/sparql/getindexedpurgeddatastreams.vm"/>
                  <!-- now reindex this object -->
                  <to uri="nmr:service:indexing:indexIndexableObject"/>
                </when>
                <otherwise>
                  <to uri="nmr:service:indexing:indexIndexableObject"/>
                </otherwise>
              </choice>
            </when>
            <when>
              <description>Does this object have the indexer CM?</description>
              <xpath>/rdf:RDF/rdf:Description/fedora-model:hasModel/@rdf:resource = 'info:fedora/indexer:cm'</xpath>
              <!-- Ordinary form to index on an indexer object -->
              <to uri="velocity:velocity/sparql/getindexeddatastreams.vm"/>
              <to uri="nmr:service:repositories:resource-index"/>
              <split parallelProcessing="true">
                <xpath>/rdf:RDF/rdf:Description</xpath>
                <setHeader headerName="pid">
                  <!-- peel out the pid itself -->
                  <xpath resultType="java.lang.String">substring-before(substring-after(/rdf:Description/@rdf:about,'/'),'/')</xpath>
                </setHeader>
                <removeHeader headerName="methodName"/>
                <to uri="nmr:service:indexing:index"/>
              </split>
            </when>
          </choice>
        </otherwise>
      </choice>
    </route>

    <route>
      <description>Index a single object</description>
      <from uri="nmr:service:indexing:indexIndexableObject"/>
      <setHeader headerName="CamelHttpUri">
        <simple>${headers.repositoryURL}/objects/${headers.pid}/methods/indexable:sdef/getIndexingMetadata")</simple>
      </setHeader>
      <setHeader headerName="CamelHttpMethod">
        <constant>GET</constant>
      </setHeader>
      <to uri="http://fedora/getIndexingMetadata"/>
      <removeHeader headerName="CamelHttpUri"/>
      <removeHeader headerName="CamelHttpMethod"/>
      <to uri="nmr:endpoint:indexing:solr:update"/>
    </route>
    
    <route>
      <description>Construct or retrieve indexing metadata for a single object</description>
      <from uri="nmr:service:indexing:getIndexingMetadata"/>
      <to uri="velocity:velocity/atom/listdatastreams.vm"/>
      <to uri="nmr:service:repositories:api-a"/>
      <choice>
        <when>
          <!-- if there exists an indexing metadata datastream -->
          <xpath>//datastreamDef/ID = 'SOLR'</xpath>
          <!-- grab it -->
          <setHeader headerName="libDatastream">
            <constant>SOLR</constant>
          </setHeader>
          <to uri="velocity:velocity/atom/getdatastream.vm"/>
          <to uri="nmr:service:repositories:api-a"/>
        </when>
        <otherwise>
          <description>Create indexing metadata from datastreams</description>
          <to uri="velocity:velocity/sparql/getindexabledatastreams.vm"/>
          <to uri="nmr:service:repositories:resource-index"/>
          <!-- swap info:fedora/ stuff for dereferencable URLs -->
          <to uri="nmr:service:indexing:concretizeURIs"/>
          <to uri="nmr:service:indexing:splitRDFDescriptions"/>
          <to uri="log:postsplitdescriptions"/>
          <split parallelProcessing="true" strategyRef="simpleXMLRecursiveMergeStrategy">
            <xpath>/rdf:RDF/rdf:Description</xpath>
            <!-- transform a single metadata stream against its XSLT -->
            <!-- stick stylesheet URL in a header -->
            <setHeader headerName="stylesheetURL">
              <xpath resultType="java.lang.String">/rdf:Description/uva-lib:isIndexedBy/@rdf:resource</xpath>
            </setHeader>
            <!-- replace body with XML datastream -->
            <setHeader headerName="CamelHttpUri">
              <xpath resultType="java.lang.String">/rdf:Description/@rdf:about</xpath>
            </setHeader>
            <setHeader headerName="CamelHttpMethod">
              <constant>GET</constant>
            </setHeader>
            <!-- this url is a dummy: the real URL is in CamelHttpUrl header
              see: http://camel.apache.org/http.html -->
            <to uri="http://www.example.com"/>
            <removeHeader headerName="CamelHttpUri"/>
            <removeHeader headerName="CamelHttpMethod"/>
            <to uri="log:retrieveddatastream"/>
            <!-- and render -->
            <to uri="nmr:endpoint:indexing:single-datastream-xslt:process"/>
          </split>
          <to uri="nmr:service:indexing:mergeAndDeduplicateSolr"/>
        </otherwise>
      </choice>
    </route>

  </camelContext>
  

  
  <bean id="simpleXMLRecursiveMergeStrategy" class="edu.virginia.lib.ole.esb.aggregation.SimpleXMLRecursiveMergeStrategy"/>

</blueprint>
