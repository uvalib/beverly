<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
    http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">
    
    <description> Router for repository connectivity. </description>
    
    <camelContext id="repoconnector" xmlns="http://camel.apache.org/schema/blueprint"
       xmlns:atom="http://www.w3.org/2005/Atom">

        <route>
            <from uri="nmr:repositories:api-m-jms"/>
            <setHeader headerName="repositoryURL">
                <xpath resultType="java.lang.String">/atom:entry/atom:author/atom:uri</xpath>
            </setHeader>
            <to uri="nmr:service:indexing:index"/>
        </route>
        
        <route>
            <from uri="nmr:repositories:api-a"/>
            <to uri="nmr:service:atomtosoap"/>
            <setHeader headerName="SOAPAction">
                <constant/>
            </setHeader>
            <!-- override with repositoryURL -->
            <setHeader headerName="CamelHttpUri">
                <simple>${headers.repositoryURL}/services/access</simple>
            </setHeader>
            <!-- default repo API-A url -->
            <to
                uri="http:fedora/services/access?authMethod=Basic&amp;authUsername=fedoraAdmin&amp;authPassword=fedoraAdmin"/>
            <removeHeader headerName="SOAPAction"/>
            <removeHeader headerName="CamelHttpUri"/>
        </route>
        
        <route>
            <from uri="nmr:repositories:api-m"/>
            <to uri="nmr:service:atomtosoap"/>
            <!-- Fedora, for some odd reason, requires a set SOAPAction header without using it -->
            <setHeader headerName="SOAPAction">
                <constant/>
            </setHeader>
            <!-- override with repositoryURL -->
            <setHeader headerName="CamelHttpUri">
                <simple>${headers.repositoryURL}/services/management?httpClient.authenticationPreemptive=true&amp;username=fedoraAdmin&amp;password=fedoraAdmin</simple>
            </setHeader>
            <!-- default repo API-A url -->
            <to uri="http:fedora/services/management"/>
            <removeHeader headerName="SOAPAction"/>
            <removeHeader headerName="CamelHttpUri"/>
        </route>
        
        <route>
            <from uri="nmr:repositories:resource-index"/>
            <setHeader headerName="Content-Type">
                <constant>application/x-www-form-urlencoded</constant>
            </setHeader>
            <setHeader headerName="CamelHttpChunked">
                <constant>false</constant>
            </setHeader>
            <setHeader headerName="CamelHttpMethod">
                <constant>POST</constant>
            </setHeader>
            <!-- override endpoint address with repositoryURL -->
            <setHeader headerName="CamelHttpUri">
                <simple>${headers.repositoryURL}/risearch</simple>
            </setHeader>
            <!-- default repo RI search url -->
            <to uri="http:fedora/risearch"/>
            <removeHeader headerName="Content-Type"/>
            <removeHeader headerName="CamelHttpChunked"/>
            <removeHeader headerName="CamelHttpUri"/>
        </route>
        
    </camelContext>
    
    <!--
    <bean id="nmr" class="org.apache.servicemix.camel.nmr.ServiceMixComponent">
        <property name="nmr">
            <reference interface="org.apache.servicemix.nmr.api.NMR" />
        </property>
    </bean>
    
    -->
    
</blueprint>
